# CSRF 跨站请求伪造
> 跨站请求伪造 CSRF（Cross-site request forgery），也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。尽管听起来像跨站脚本（XSS），但它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装来自受信任用户的请求来利用受信任的网站。与XSS攻击相比，CSRF攻击往往不大流行（因此对其进行防范的资源也相当稀少）和难以防范，所以被认为比XSS更具危险性。但往往同XSS一同作案！

### CSRF可以做什么？
你这可以这么理解CSRF攻击：攻击者盗用了你的身份，以你的名义发送恶意请求。CSRF能够做的事情包括：以你名义发送邮件，发消息，盗取你的账号，甚至于购买商品，虚拟货币转账......造成的问题包括：个人隐私泄露以及财产安全。

### CSRF漏洞现状
CSRF这种攻击方式在2000年已经被国外的安全人员提出，但在国内，直到06年才开始被关注，08年，国内外的多个大型社区和交互网站分别爆出CSRF漏洞，如：NYTimes.com（纽约时报）、Metafilter（一个大型的BLOG网站），YouTube和百度HI......而现在，互联网上的许多站点仍对此毫无防备，以至于安全业界称CSRF为“沉睡的巨人”。

### CSRF原理
#### 本质上讲，`XSS 是代码注入问题`，`CSRF 是 HTTP 问题`。XSS 是内容没有过滤导致浏览器将攻击者的输入当代码执行。CSRF 则是因为浏览器在发送 HTTP 请求时候自动带上 cookie，而一般网站的 session 都存在 cookie里面。

下图简单阐述了CSRF攻击的思想：

![](https://user-gold-cdn.xitu.io/2017/9/22/e974cf8e975df7a6e9e31592ce4b007b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

从上图可以看出，要完成一次CSRF攻击，受害者必须依次完成两个步骤：

1. 登录受信任网站A，并在本地生成Cookie。
2. 在不登出A的情况下，访问危险网站B。

### 案例
* 比如某网站的转账操作
* 受害者张三给李四转账100，
* 通过对银行的网站发起请求 bank.example/transfer?ac… ，
* 通常情况下，该请求发出后，服务器端会检查 session 是否合法，并且张三已经登录成功，
* 黑客王五可以自己给银行发送一个请求 bank.example/transfer?ac… ，但是这个请求来自王五，而不是张三，他并不能通过安全认证。他需要张三的 session 。
* 王五自己做了一个网站，放入如下代码 bank.example/transfer?ac… ，用各种方式诱使张三点击自己的网站。
* 张三登录了银行的网站没有退出，访问了黑客王五的网站，上述的 url 就会向银行发起请求。
* 如果session没有过期，这时悲剧就发生了，张三的账户里少了1000。

### 当前防御 CSRF 的几种策略
#### 1. 验证 HTTP Referer 字段
利用HTTP头中的Referer判断请求来源是否合法。

**优点**：

简单易行，只需要在最后给所有安全敏感的请求统一增加一个拦截器来检查 Referer 的值就可以。特别是对于当前现有的系统，不需要改变当前系统的任何已有代码和逻辑，没有风险，非常便捷。

**缺点**：

* Referer 的值是由浏览器提供的，不可全信，低版本浏览器下Referer存在伪造风险。

* 用户自己可以设置浏览器使其在发送请求时不再提供 Referer时，网站将拒绝合法用户的访问。

#### 2. 在请求地址中添加 token 并验证
在请求中放入黑客所不能伪造的信息，并且该信息不存在于 cookie 之中，以HTTP请求参数的形式加入一个随机产生的 token交由服务端验证

**优点**：

比检查 Referer 要安全一些，并且不涉及用户隐私。

**缺点**：

对所有请求都添加token比较困难，难以保证 token 本身的安全，依然会被利用获取到token

#### 3. 在 HTTP 头中自定义属性并验证+One-Time Tokens
将token放到 HTTP 头中自定义的属性里。通过 XMLHttpRequest 的异步请求交由后端校验，并且一次有效。

**优点**：

统一管理token输入输出，可以保证token的安全性

**缺点**：

有局限性，无法在非异步的请求上实施

#### 4. 验证码（此种方式能很好的遏制 csrf，但是用户体验比较差）

#### 5. 尽量使用post（但是 post 也并不是万无一失，攻击者只需要构造一个form就可以。）
